<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.noncore.assessment.mapper.AiMessageMapper">

    <resultMap id="BaseResultMap" type="com.noncore.assessment.entity.AiMessage">
        <id column="id" property="id"/>
        <result column="conversation_id" property="conversationId"/>
        <result column="user_id" property="userId"/>
        <result column="role" property="role"/>
        <result column="content" property="content"/>
        <result column="attachments" property="attachments"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, conversation_id, user_id, role, content, attachments, created_at
    </sql>

    <insert id="insert" parameterType="com.noncore.assessment.entity.AiMessage" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ai_messages (conversation_id, user_id, role, content, attachments, created_at)
        VALUES (#{conversationId}, #{userId}, #{role}, #{content}, #{attachments}, NOW())
    </insert>

    <select id="listByConversation" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ai_messages
        WHERE conversation_id = #{conversationId}
        ORDER BY created_at ASC
        LIMIT #{offset}, #{size}
    </select>

    <select id="countByConversation" resultType="long">
        SELECT COUNT(*)
        FROM ai_messages
        WHERE conversation_id = #{conversationId}
    </select>

    <!-- 删除超出 keep 的最老消息：保留最新 keep 条 -->
    <delete id="deleteOldestExceeding">
        DELETE FROM ai_messages
        WHERE conversation_id = #{conversationId}
          AND id IN (
              SELECT id FROM (
                  SELECT id
                  FROM ai_messages
                  WHERE conversation_id = #{conversationId}
                  ORDER BY created_at ASC
                  LIMIT GREATEST(0, (SELECT COUNT(*) FROM ai_messages WHERE conversation_id = #{conversationId}) - #{keep})
              ) AS t
          )
    </delete>

    <delete id="deleteByConversation">
        DELETE FROM ai_messages WHERE conversation_id = #{conversationId}
    </delete>

    <select id="countAssistantMessagesByModelSince" resultType="long">
        SELECT COUNT(*)
        FROM ai_messages m
        JOIN ai_conversations c ON m.conversation_id = c.id
        WHERE m.user_id = #{userId}
          AND c.user_id = #{userId}
          AND c.model LIKE CONCAT(#{modelPrefix}, '%')
          AND m.role = 'assistant'
        <if test="since != null">
          AND m.created_at &gt;= #{since}
        </if>
    </select>

</mapper>


