<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.noncore.assessment.mapper.AdminUserMapper">

    <sql id="userListColumns">
        u.id,
        u.username,
        u.email,
        u.role,
        u.status,
        u.avatar,
        u.nickname,
        u.first_name,
        u.last_name,
        u.student_no,
        u.teacher_no,
        u.email_verified,
        u.deleted,
        u.created_at,
        u.updated_at
    </sql>

    <sql id="whereClause">
        <where>
            <if test="includeDeleted == false">
                u.deleted = false
            </if>
            <if test="role != null and role != ''">
                <if test="includeDeleted == false">
                    AND
                </if>
                u.role = #{role}
            </if>
            <if test="status != null and status != ''">
                AND u.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                    u.username LIKE CONCAT('%', #{keyword}, '%')
                    OR u.email LIKE CONCAT('%', #{keyword}, '%')
                    OR u.nickname LIKE CONCAT('%', #{keyword}, '%')
                    OR u.student_no LIKE CONCAT('%', #{keyword}, '%')
                    OR u.teacher_no LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </sql>

    <select id="pageUsers" resultType="com.noncore.assessment.dto.response.admin.AdminUserListItemResponse">
        SELECT <include refid="userListColumns"/>
        FROM users u
        <include refid="whereClause"/>
        ORDER BY u.created_at DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="countUsers" resultType="long">
        SELECT COUNT(1)
        FROM users u
        <include refid="whereClause"/>
    </select>

    <update id="updateUserRole">
        UPDATE users
        SET role = #{role}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="updateUserStatus">
        UPDATE users
        SET status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>

