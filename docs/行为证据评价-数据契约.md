## 行为证据评价：数据契约（两阶段）

本文件定义“行为证据评价”模块的数据口径与 JSON 契约，确保：

- **行为不算分**：行为数据不参与任何加权平均、总评、排名。
- **唯一数值分数**：系统唯一数值分数仍为“作业成绩”（作业评分模块产出）。
- **两阶段**：
  - 阶段一（不调用 AI）：把行为事件聚合为可审计的结构化摘要（JSON）。
  - 阶段二（阶段性调用 AI）：仅基于摘要做“解释与总结”，不负责计算。

> 注意：本模块允许统计（count/rate 等）作为事实描述，但这些不是成绩，也不得被解释为分数。

---

## 1. Schema 版本

- **阶段一摘要**：`behavior_summary.v1`
- **阶段二洞察**：`behavior_insight.v2`

任何字段变更都应升级版本号，并同步更新本文件与后端常量 `BehaviorSchemaVersions`。

---

## 2. 行为事件字典（事实记录）

事件记录为 append-only 的“事实”。事件类型使用 `eventType`（字符串 code）：

| eventType code | 含义 | 备注 |
|---|---|---|
| `ai_question` | AI 提问（首次问题） | 记录问题发生事实，不做质量评价 |
| `ai_follow_up` | AI 追问（进一步追问/澄清） | 同上 |
| `assignment_submit` | 作业提交 | 仅记录提交动作 |
| `assignment_resubmit` | 作业修改/重交 | 仅记录修改与再次提交动作 |
| `community_ask` | 社区发问 | 仅记录发帖/提问动作 |
| `community_answer` | 社区回答 | 仅记录回答/回复动作 |
| `feedback_view` | 查看反馈 | 如查看成绩评语、老师反馈、系统建议等 |
| `resource_view` | 资源访问 | **只记录不评价**（必须进入 nonEvaluative 分组） |

### 2.1 元数据（metadata）建议字段

不同事件可携带 `metadata`（JSON），用于聚合与回溯（可扩展）：

- `courseId`：课程上下文
- `assignmentId`/`submissionId`：作业/提交上下文
- `postId`/`commentId`：社区上下文
- `conversationId`/`messageId`：AI 对话上下文
- `resourceId`/`resourceType`：资源上下文（仅记录）
- `link`：可选跳转 deeplink（用于前端定位）

---

## 3. 阶段一：行为摘要（BehaviorSummarySnapshot JSON）

### 3.1 目标

- 对指定时间窗内的事件做聚合，输出结构化 JSON
- **可审计可复现**：同一事件集合 → 输出稳定
- **不调用 AI**：所有字段由规则/统计计算产生

### 3.1.1 快照与刷新（重要）

- 阶段一摘要会优先复用最近一次摘要快照（降低重复计算与数据库压力）
- 若检测到快照生成后出现了新行为事件（如 AI 提问/作业提交/社区发问），将自动重新聚合并写入新快照，确保计数及时更新

### 3.1.2 courseId 过滤说明（重要）

当调用摘要接口并传入 `courseId` 时，聚合输入事件集合应包含：

- `course_id = courseId` 的课程内事件（例如：作业提交/查看反馈等）
- 以及**无法归属具体课程的全局事件**（`course_id` 为空），例如：
  - 社区发帖/评论（通常不带课程上下文）
  - 未携带课程上下文的 AI 提问/追问

### 3.2 字段要求（v1）

顶层字段：

- `schemaVersion`：`behavior_summary.v1`
- `meta`：学生/课程/时间窗/生成信息
- `activityStats`：事实统计（AI/作业/社区/反馈/资源）
- `evidenceItems[]`：证据条目（必须有 `evidenceId` 与 `eventRefs[]`）
- `nonEvaluative`：只记录不评价的事件汇总（例如资源访问）
- `signals`：可复现的规则信号（布尔/枚举），用于约束阶段二解读

#### 3.2.1 时间维度与抗刷/抗噪（signals 扩展约定）

为避免“短时间刷记录”污染洞察质量，阶段一会在 `signals` 中补充以下**纯事实**字段（不算分、不评价）：

- `activeDays`：时间窗内活跃天数（按 occurredAt 的自然日去重）
- `timeSignals`（对象）：
  - `submitLast24hShare`：提交类事件（submit+resubmit）发生在时间窗最后 24h 的占比（0-1）
  - `submitMaxDailyShare`：提交类事件集中在单日的最大占比（0-1）
  - `aiMaxDailyShare`：AI 事件集中在单日的最大占比（0-1）
  - `burstAny / burstAi / burstSubmit`：是否检测到短时间内的 burst（仅提示可能刷记录）
- `antiSpam`（对象，仅用于抗噪提示，不作为能力证据）：
  - `dailyCaps`：各事件类型的“每日计数上限”口径（用于计算有效计数）
  - `effectiveCountsByType`：应用 dailyCaps 后的有效计数（对冲短时刷量）
  - `burstAll / burstAi / burstSubmit`：burst 检测的窗口参数与 maxInWindow

> 注意：以上信号用于阶段二“解释与建议”的约束与提示，避免把刷量当成高质量学习行为；不得被解释为分数或评价。

### 3.3 evidenceId 规则

- `evidenceId` 必须唯一、稳定（建议包含日期与序号）
- 阶段二所有结论必须引用 `evidenceIds[]`
- 没有 evidence 引用的结论视为无效（治理规则）

### 3.4 示例（v1）

```json
{
  "schemaVersion": "behavior_summary.v1",
  "meta": {
    "studentId": 1,
    "courseId": 10,
    "range": "7d",
    "from": "2026-01-01 00:00:00",
    "to": "2026-01-08 00:00:00",
    "generatedAt": "2026-01-08 12:00:00",
    "inputEventCount": 42,
    "eventTypesIncluded": ["assignment_submit", "feedback_view", "resource_view"]
  },
  "activityStats": {
    "ai": { "questionCount": 5, "followUpCount": 2, "followUpRate": 0.4, "topicTags": ["递归", "复杂度"] },
    "assignment": { "submitCount": 3, "resubmitCount": 1, "resubmitAfterFeedbackCount": 1 },
    "community": { "askCount": 1, "answerCount": 2 },
    "feedback": { "viewCount": 4 },
    "resource": { "viewCount": 10, "byCategory": { "video": 3, "pdf": 7 } }
  },
  "evidenceItems": [
    {
      "evidenceId": "ev_20260108_0001",
      "evidenceType": "feedback_iteration",
      "title": "查看反馈后进行修改",
      "description": "本周在查看反馈后对作业进行了 1 次修改。",
      "eventRefs": [1001, 1002],
      "occurredAt": "2026-01-06 14:30:00",
      "link": "/assignments/1/submissions/2"
    }
  ],
  "nonEvaluative": {
    "items": [
      { "eventType": "resource_view", "count": 10, "meta": { "byCategory": { "video": 3, "pdf": 7 } } }
    ]
  },
  "signals": {
    "highIterationOnFeedback": true,
    "lowCommunityEngagement": false
  }
}
```

---

## 4. 阶段二：行为洞察（BehaviorInsight JSON，AI 只负责解释与总结）

### 4.1 目标与强约束

- 只做：
  - **解释分数**（解释“作业成绩”背后的过程与证据）
  - **阶段性能力判断（非分数）**
  - **形成性反馈建议**
- 严禁：
  - 输出任何“新分数/百分比/加权结果”
  - 生成排名、总评、综合分
  - 将 `resource_view` 等只记录事件作为能力正负证据

### 4.2 字段要求（v2）

- `schemaVersion`：`behavior_insight.v2`
- `snapshotId`：引用阶段一快照（用于审计）
- `explainScore`：解释文本 + `evidenceIds[]`
- `stageJudgements[]`：维度判断（枚举档位）+ `evidenceIds[]`
- `formativeSuggestions[]`：建议条目（可执行）+ 可选 `evidenceIds[]`
- `riskAlerts[]`：结构化风险预警（severity/title/message，可选 dimensionCode）+ `evidenceIds[]`
- `actionRecommendations[]`：结构化行动建议（title/description/nextActions，可选 dimensionCode）+ `evidenceIds[]`
- `meta`：生成时间/模型/promptVersion/状态

### 4.3 能力维度与档位（枚举）

维度编码（不含学习成绩维度）：

- `MORAL_COGNITION`
- `LEARNING_ATTITUDE`
- `LEARNING_ABILITY`
- `LEARNING_METHOD`

档位枚举（非分数）：

- `EMERGING`
- `DEVELOPING`
- `PROFICIENT`
- `ADVANCED`

### 4.4 示例（v2）

```json
{
  "schemaVersion": "behavior_insight.v2",
  "snapshotId": 101,
  "explainScore": {
    "text": "本周的作业成绩主要反映了你在收到反馈后能够及时迭代修改，并通过多次提问澄清关键概念。",
    "evidenceIds": ["ev_20260108_0001"]
  },
  "stageJudgements": [
    {
      "dimensionCode": "LEARNING_METHOD",
      "level": "DEVELOPING",
      "rationale": "你能基于反馈进行对照修改，但在形成稳定的自查清单方面仍有提升空间。",
      "evidenceIds": ["ev_20260108_0001"]
    }
  ],
  "formativeSuggestions": [
    {
      "title": "建立一次提交前自查清单",
      "description": "在提交前用 3 条自查点快速扫一遍：概念是否定义清楚、步骤是否完整、例子是否覆盖边界。",
      "nextActions": ["整理 3 条自查点", "下次提交前对照打勾"],
      "evidenceIds": ["ev_20260108_0001"]
    }
  ],
  "riskAlerts": [
    {
      "severity": "warn",
      "title": "近7天学习节奏不稳定",
      "message": "出现集中在少数天突击式学习的迹象，建议把学习任务拆分到更多天以形成稳定节奏。",
      "dimensionCode": "LEARNING_ATTITUDE",
      "evidenceIds": ["ev_20260108_0001"]
    }
  ],
  "actionRecommendations": [
    {
      "title": "把反馈迭代固化成自查清单",
      "description": "把本周你做得有效的“对照修改”固化为 3 条提交前自查点，减少下次重复踩坑。",
      "nextActions": ["提炼 3 条自查点", "下次提交前逐条对照打勾"],
      "dimensionCode": "LEARNING_METHOD",
      "evidenceIds": ["ev_20260108_0001"]
    }
  ],
  "meta": {
    "generatedAt": "2026-01-08 12:05:00",
    "model": "google/gemini-2.5-pro",
    "promptVersion": "behavior_insight_prompt.v2",
    "status": "success"
  }
}
```

---

## 5. 治理规则（必须执行）

- **阶段一禁止调用 AI**：事件采集与摘要聚合全链路不得触发任何 AI 调用。
- **阶段二只读**：AI 输入必须是阶段一摘要 JSON；禁止把原始事件全文直接交给 AI（避免泄露与不可控）。
- **证据引用强制**：洞察输出必须引用 evidenceId；无引用内容不展示/不入库（可选：标记为 failed/partial）。
- **只记录不评价隔离**：`resource_view` 等事件必须进入 `nonEvaluative`，并在 prompt 中明确禁止作为能力依据。

## 行为证据评价：数据契约（两阶段）

本文件定义“行为证据评价”模块的数据口径与 JSON 契约，确保：

- **行为不算分**：行为数据不参与任何加权平均、总评、排名。
- **唯一数值分数**：系统唯一数值分数仍为“作业成绩”（作业评分模块产出）。
- **两阶段**：
  - 阶段一（不调用 AI）：把行为事件聚合为可审计的结构化摘要（JSON）。
  - 阶段二（阶段性调用 AI）：仅基于摘要做“解释与总结”，不负责计算。

> 注意：本模块允许统计（count/rate 等）作为事实描述，但这些不是成绩，也不得被解释为分数。

---

