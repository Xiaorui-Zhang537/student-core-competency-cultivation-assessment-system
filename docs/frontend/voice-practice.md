# 实时语音口语训练（学生端/教师端）

## 1. 功能概览

该功能用于学生进行 **口语训练**：浏览器实时采集麦克风音频，AI 可实时返回 **文字** 或 **音频**。其中“音频+文字”会通过 **音频输出 + 自动转写** 的方式同时展示文本。

> 说明：Gemini Live 单次会话不能同时配置 TEXT+AUDIO 输出，所以“音频+文字”不是双模输出，而是 **AUDIO + outputAudioTranscription**（拿到文字转写）。

特点：
- **实时**：边说边传，边收边播
- **可复盘**：结束后保存本次训练的用户音频、AI 音频与文字转写，可在 AI 助理会话里回放
- **统一主题**：界面使用项目现有玻璃风组件（`/frontend/src/components/ui`）

## 2. 入口

- 学生端：进入「AI 助理」→ 右上角「语音练习」
- 教师端：进入「AI 助理」→ 右上角「语音练习」

路由：
- `/student/assistant/voice`
- `/teacher/assistant/voice`

## 3. 使用流程

1. 点击「开始」（开始本轮）
2. 浏览器弹出麦克风权限请求，允许后开始录音
3. 说话过程中：
   - 页面会显示你的转写（若模型开启了输入转写）
   - AI 会按你选择的输出方式返回文字或音频；若选择「音频+文字」，页面会展示 AI 音频对应的文字转写
4. 点击「结束本轮（触发回复）」：立即触发模型生成一条回复
5. 系统会自动：
   - 上传用户音频（`purpose=ai_voice`）
   - 上传 AI 音频（WAV）
   - 调用 `POST /api/ai/voice/turns` 写入会话消息
6. 回到 AI 助理页，可在会话消息中播放保存的音频附件

## 4. 常见问题

### 4.1 没有声音 / 提示无权限
- 检查浏览器是否允许站点使用麦克风权限
- macOS 还需检查「系统设置 → 隐私与安全性 → 麦克风」中浏览器权限

### 4.2 音频播放失败
- 检查是否登录态失效（需要 token 才能访问文件流）
- 服务器返回音频为 PCM 分片时，前端会边播边缓冲；结束后会生成 WAV 用于回放

## 5. 技术对接要点（给开发者）

- WebSocket：`/api/ai/live/ws?token=...`（后端代理 Gemini Live）
- 回合入库：`POST /api/ai/voice/turns`
- 文件上传：`POST /api/files/upload`（purpose=ai_voice, relatedId=conversationId）

